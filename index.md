# BlindX

<p align="center">
    <img src="./screenshots/title0.jpg" width="640">
</p>

## 概要

### 日本語変換コア

BlindX は Transformer T5 (Text-to-Text Transfer Transformer) をベースにした推論機能を用いたな日本語処理
フロントエンドです。AI機能のもつ柔軟な日本語生成機能をもちながら、人間との最初のインターフェースとして素早く快適な応答を実現します。推論は GPU を使用した専用のサーバを介して行われます。
その結果を用いて使用のバリアの低い UI をもつエッジクライアントを構築できることを目指します。

ここでは大きな処理の流れを説明します。コードの詳細はリポジトリを参照ください。

### サーバとの通信

BlindX サーバの自体は単純な websocket による非同期 echo サーバです。最も基本的な通信ではクライアントがひらがな文を送信すると
対応するかな漢字文が返信されます。


```python python 
import asyncio
while self.websocket:
    try:            
        if text:
            await self.websocket.send(dict_type + text)
            return await self.websocket.recv()
        else:
            return ''
    except websockets.ConnectionClosed:
        self.websocket.close()
        self.websocket = await websockets.connect(self.uri)
```

サーバでの変換はスレッドごとにひとつの send() に対して対応するひとつの recv() で完結し、ステートレスで行われます。
すなわちサーバ側はクライアントの送信した以前の状態は保持しません。

変換に際して、辞書の指定や前後の文脈などのコンテクストは、その都度再送信されます。


### 辞書の選択

変換にあたっては異なるコーパス（語彙のデータベース）から学習させた複数の辞書から適切なものが選択されます。

辞書の一例として以下のものがあります。

| 辞書名 | 下敷きとしたコーパス |
|-------|----------------|
| aozora256 | 青空文庫コーパス |
| wiki256 |  wikipedia コーパス |
| 2ch256 |  おーぷん２ちゃんねる対話コーパス |
| cc256 |  CC-100 コーパス |

これらの辞書は個人ごとではなく、それぞれの対象領域の語彙集合が時代とともに推移していくの合わせに更新されます。

辞書の選択は多くの場合アプリケーションの特性に応じて選ばれ、最終ユーザが意識することはありません。

## 変換の実際

### プリプロセッサ

Blindx は本体は、字句解析前の日本語ひらがなを入力とします。
しかしユーザから見るとひらがな入力が最前線のインターフェースではなく、実際の入力手段はモーダル（使用形態）によって異なります

そこで BlindX ではモーダルごとに別個にプリプロセッサが置かれます。

<pre>

+-------------+  +------------------+
| Flick Input +--+ Error correction + ------------------------+
+-------------+  +------------------+                         |
                                                              |
+-------------+  +------------------+ +--------------------+  |
| keyboard    +--+ Error correction +-+ romaji-to-hiragana +--+-- Hiragana - BlindX
+-------------+  +------------------+ +--------------------+  | 
                                                              |
+-------------+  +-----------------+ +------------------+     |
| Audio input +--+ speech-to-text  +-* error correction +-----+
+-------------+  +-----------------+ +------------------+

</pre>

場合によってはその前後の処理段階でモーダル特有の軽微な誤入力を修正するフィルタが挿入されます。
デスクトップアプリではキーボードのローマ字入力をひらがな文字列に変換する部分がこれにあたります。

> blindX のローマ字変換
> blindX のデフォルトのローマ字ひらがなパーサはいくつか拡張がされています。
> 多くは既存の IME との相互運用を容易にするためのものです。
> - 半角英数字も一旦全角英数字に変換されます
>   - （入力）**2025ねん1がつ１にち** → （出力）**２０２５ねん１がつ１にち**



はじめからかな漢字のものはひらがなのまま出力されます

ashitanotenkiは晴れdatoomou

あしたのてんきは晴れだとおもう

'`' (バッククォート）された範囲は半角ローマ字のまま出力されます。

Hey Jude habi-toruzunogakkyokudesu

Hey Jude はびーとるずのがっきょくです

#### ライブ変換

変換は最小で１文字から入力されるたびに即座に要求が発行されます。
この間隔は調整できます。
ただし実際に変換が行われるかどうかはキーボードの入力速度とその時のサーバのレイテンシによって判断されます。
キーボードの入力が十分遅い場合は

あしたのてんきははれだとおもう

あ	あ
あし	足
あした	明日
あしたの あしたの
あしたのて 明日のて
あしたのてんきははれだとおもう

あしたのてんきははれだとおもう 明日の天気は晴れだと思う

ここでサーバへの変換要求は以前の変換の返答がくるまでペンディングされます。
それまでは入力されたひらがなが、最新の変換後のかな漢字に追加され、直前の変換が確定した時点で
最新のかな漢字結果に反映されます。
ここでの変換は応答性を優先しているので、正確な変換は再度長いウィンドウで再度実行されます。（複数パス）

#### 並列の変換

#### 文脈をみた変換

#### 文章の訂正

一旦確定した文章の修正には打ち間違いによる誤変換などの小規模なものと、より広い文脈を見た上でのものがあり、ここでは
前者を訂正、後者を校正と呼びます。

軽微な訂正は BlindX ができるだけ自動的に訂正することを試みます。
この場合はユーザは訂正があったこと自体意識しません。
そのあとの修正は、通常の日本語変換と同じように、ユーザが特定の部分の変換結果を候補から指定し、その条件下で再度全文を推定
する操作を行います。場合によっては一箇所を修正すると周辺のも再推論の結果自動的に適切に変更されます。

#### 校正

より広い校正は、すでに一旦かな漢字が確定した以前の内容まで遡って再度翻訳単位に含めることで行われます。
推論器は状況を推測して続く入力の変換の精度を向上させます。
これは会話文の羅列のような短い断片的な文が続くケースでは有効に作用します。
校正処理は入力の明確な区切り、句点や改行が検出された時点でのみ行われます。

しかもあとできくとそれは		しかもあとできくと
しょせいという			しかもあとできくと + しょせいという		
よのなかでもっとも		しかもあとできくと + しょせいという + よのなかでもっとも		
どうあくないきものだそうだ		しかもあとできくと + しょせいという + よのなかでもっとも + どうあくないきものだそうだ

この例では、例えば

しかもあとできくとそれは
しょせいという
しかもあとできくと + しょせいという
よのなかでもっとも
しかもあとできくと + しょせいという + よのなかでもっとも
どうあくないきものだそうだ		
しかもあとできくと + しょせいという + よのなかでもっとも + どうあくないきものだそうだ

が実行され、最終的に
最後の変換結果は遡って以前の結果にも反映されます。
（実際には参照する文章のウィンドウもスライドしていくため、どの候補で修正されるかはウィンドウの位置によって異なります。）


なまえはまだない。
どこでうまれたか

#### 広範囲な校正（オプション）

グループウェアやチャットのように多数のユーザがひとつの流れの文章をリアルタイム構成していくアプリケーションでは
全員のコンテキストを保持しておいて、広範な範囲で blindx のサーバで変換・編集をかけることが可能です。
各クライアントからの入力を時系列でマージして長いチャンク


## ショーケースとベストプラクティス

こうした機能のクライアント側の MIT ライセンスによるショーケースのコードが github にありますのでご参照ください。
ここでのコードにはいくつかの制限事項があります。

### Webアプリとデスクトップアプリ（モバイルアプリ）

BlindX は Web アプリとデスクトップアプリで基本構成は変わりませんが、コンテクストの共有とセキュリティの扱いが異なります。
Web アプリでは動的な UI で WSGI/ASGI など非同期な Web サーバが一般的に使われます。
この倍は、BlindX は実際には Web サーバと BlidX サーバの間で行なうことが考えられます。
一方スタンドアロンのアプリの場合、または Web アプリでもより高速に日本語変換を行いたい場合は、BlindX サーバとの通信は認証が完了したのちクライアントとの直接通信になります。
さらに加えてまた異なるクライアントからの入力を文脈に含めるため、共有機構が別途必要なります。
ここではサーバサイドアプリケーションを前提としておりスダンドアローンアプリとして使用する場合は数カ所の変更が必要になります。

### スレッドと asyncio

blindx websocket 通信を  UI のバックグラウンドで行うのには asyncio とスレッドのいずれを使うこともできます。
可能な環境であれば asyncio ではなくスレッドを使うほうがサーバのコストを少なく素早い反応が期待できます。
変換処理自体は非常に軽量なためマシンあたり多くのリクエストを管理できます。そこで入力頻度が低い場合などで
入力が中断しているセッションは一旦接続を解除し、より多くの同時接続を試みることができます。この場合には
UI と同じイベントループで send()/recv() を行うよりは別スレッドのほうが有利となります。

### ショーケースで使用している UI フレームワーク

ショーケースの UIフレームワークでは flet を使用しています。

https://flet.dev/

BlindX に関わる部分は分離されています。

## Compare

実際の日本語変換機能の基本テストを行います。
参考までに mozcpy を用いた変換結果も同時に表示します。

https://github.com/ikegami-yukino/mozcpy

<p align="center">
   <video src="./screenshots/scompare2.mp4" controls="true" width="640"></video>
</p>


ソースコードはこちらを参照ください

## Real-time Chat

非同期なリアルタイムチャット

共有された広い範囲の文脈を使ったメッセージングアプリの例です。
日本語変換のリアルタイム性とあいまって、より音声会話に近い感覚でテキスト会話が可能になります。

<p align="center">
   <video src="./screenshots/schat2.mp4" controls="true" width="480"></video>
</p>

ソースコードはこちらを参照ください


## On-line Edit

パラグラフにまたがった広範囲の日本語変換をおこなったテキストエディタです。
またより低レベルのキーボード入力をハンドルしている例にもなっています。
最初のキーバインドは linux でのデフォルトの readline/emacs のキーバインドに沿っています。

<p align="center">
   <video src="./screenshots/report4.mp4" controls="true" width="640"></video>
</p>

コードはこちら


